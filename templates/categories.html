<!DOCTYPE html>
<html lang="bg">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Добавяне на продукти в категории</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
	<style>
		:root {
			--primary-color: #2c5530;
			--secondary-color: #4a7c59;
			--accent-color: #8fbc8f;
			--light-color: #f8f9fa;
			--dark-color: #343a40;
			--categorized-bg: #e8f5e8;
			--categorized-border: #c8e6c9;
		}
		
		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
			background-color: #f5f5f5;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}
		
		.container-fluid {
			height: 100vh;
			padding: 0;
		}
		
		.card {
			height: 100%;
			border: none;
			border-radius: 0;
		}
		
		.card-header {
			background-color: var(--primary-color) !important;
			color: white;
			border-radius: 0 !important;
			padding: 0.75rem 1rem;
		}
		
		.card-body {
			padding: 1rem;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
		}
		
		.loading-screen {
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			height: 100%;
			text-align: center;
		}
		
		.progress {
			width: 80%;
			height: 20px;
			margin: 20px 0;
		}
		
		.main-content {
			display: none;
			flex: 1;
			flex-direction: column;
			min-height: 0;
		}
		
		.btn-primary {
			background-color: var(--secondary-color);
			border-color: var(--secondary-color);
		}
		
		.btn-primary:hover {
			background-color: var(--primary-color);
			border-color: var(--primary-color);
		}
		
		.btn-outline-secondary {
			color: var(--secondary-color);
			border-color: var(--secondary-color);
		}
		
		.btn-outline-secondary:hover {
			background-color: var(--secondary-color);
			color: white;
		}
		
		.btn-success {
			background-color: var(--accent-color);
			border-color: var(--accent-color);
			color: var(--dark-color);
		}
		
		.btn-success:hover {
			background-color: #7aa87a;
			border-color: #7aa87a;
		}
		
		.btn-danger {
			background-color: #dc3545;
			border-color: #dc3545;
		}
		
		.btn-danger:hover {
			background-color: #c82333;
			border-color: #bd2130;
		}
		
		.btn-export {
			background-color: #6c757d;
			border-color: #6c757d;
			color: white;
		}
		
		.btn-export:hover {
			background-color: #5a6268;
			border-color: #545b62;
		}
		
		.table-hover tbody tr:hover {
			background-color: rgba(143, 188, 143, 0.1);
		}
		
		.categorized-row {
			background-color: var(--categorized-bg) !important;
			border-left: 4px solid var(--categorized-border);
		}
		
		.categorized-row:hover {
			background-color: #d4edda !important;
		}
		
		.search-section {
			background-color: white;
			border-radius: 0.375rem;
			padding: 1rem;
			margin-bottom: 1rem;
			box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
		}
		
		.table-container {
			flex: 1;
			overflow-y: auto;
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			background-color: white;
		}
		
		.table {
			margin-bottom: 0;
		}
		
		.table thead th {
			position: sticky;
			top: 0;
			background-color: #e9ecef;
			z-index: 10;
		}
		
		.error-message {
			color: #dc3545;
			background-color: #f8d7da;
			border: 1px solid #f5c6cb;
			border-radius: 0.375rem;
			padding: 1rem;
			margin: 1rem 0;
		}
		
		.no-results {
			text-align: center;
			padding: 2rem;
			color: #6c757d;
		}
		
		.search-prompt {
			text-align: center;
			padding: 3rem;
			color: #6c757d;
		}
		
		.action-buttons {
			display: flex;
			gap: 0.5rem;
			justify-content: flex-end;
		}
		
		.category-badge {
			background-color: var(--accent-color);
			color: var(--dark-color);
			font-weight: 500;
			padding: 0.25rem 0.5rem;
			border-radius: 0.25rem;
			font-size: 0.875rem;
		}
	</style>
</head>
<body>
	<div class="container-fluid">
		<div class="card shadow">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h1 class="h3 mb-0"><i class="bi bi-cart-check"></i> Добавяне на продукти в категории</h1>
				<button id="exportCsv" class="btn btn-export" disabled>
					<i class="bi bi-download"></i> Експорт CSV
				</button>
			</div>
			<div class="card-body">
				<!-- Loading Screen -->
				<div id="loadingScreen" class="loading-screen">
					<div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
					<h3 class="mt-3" id="loadingTitle">Зареждане на данни...</h3>
					<p id="loadingMessage">Моля, изчакайте докато се обработват данните от базата.</p>
					<div class="progress">
						<div id="loadingProgress" class="progress-bar progress-bar-striped progress-bar-animated"
							role="progressbar" style="width: 0%"></div>
					</div>
					<div id="loadingDetails" class="mt-2">
						<small>Обработва се: <span id="currentMarket">-</span></small><br>
						<small>Прогрес: <span id="progressPercent">0</span>%</small>
					</div>
					<div id="errorMessage" class="error-message mt-3" style="display: none;">
						<h5><i class="bi bi-exclamation-triangle"></i> Грешка при обработка на данните</h5>
						<p id="errorText"></p>
						<button class="btn btn-warning mt-2" onclick="location.reload()">Опитайте отново</button>
					</div>
				</div>

				<!-- Main Content (hidden until loading completes) -->
				<div id="mainContent" class="main-content">
					<!-- Category selection -->
					<div class="row mb-3">
						<div class="col-md-12">
							<label for="categorySelect" class="form-label fw-bold">Избери категория:</label>
							<select class="form-select" id="categorySelect">
								<option value="" selected>-- Моля, изберете категория --</option>
								<option value="1">1. Бял хляб от 500 гр. до 1 кг</option>
								<option value="2">2. Хляб Добруджа от 500 гр. до 1 кг</option>
								<option value="3">3. Ръжен хляб от 400 гр. до 600 гр.</option>
								<option value="4">4. Типов хляб от 400 гр. до 600 гр.</option>
								<option value="5">5. Точени кори от 400 гр. до 500 гр.</option>
								<option value="6">6. Прясно мляко от 2 % до 3.6 % 1 л</option>
								<option value="7">7. Кисело мляко от 2 % до 3.6 % в кофички от 370 гр. до 500 гр.</option>
								<option value="8">8. Сирене от краве мляко насипно 1 кг</option>
								<option value="9">9. Сирене от краве мляко пакетирано за 1 кг</option>
								<option value="10">10. Кашкавал от краве мляко насипно 1 кг</option>
								<option value="11">11. Кашкавал от краве мляко пакетирано за 1 кг</option>
								<option value="12">12. Краве масло от 125 гр. до 250 гр.</option>
								<option value="13">13. Извара насипна 1 кг.</option>
								<option value="14">14. Извара пакетирана от 200 гр. до 1 кг.</option>
								<option value="15">15. Прясно охладено пиле 1 кг (цяло)</option>
								<option value="16">16. Пилешко филе, охладено, 1 кг</option>
								<option value="17">17. Пилешки бут, цял, охладен 1 кг</option>
								<option value="18">18. Прясно свинско месо плешка 1 кг</option>
								<option value="19">19. Прясно свинско месо бут 1 кг</option>
								<option value="20">20. Прясно свинско месо шол 1 кг</option>
								<option value="21">21. Прясно свинско месо врат 1 кг</option>
								<option value="22">22. Свинско месо за готвене 1 кг</option>
								<option value="23">23. Телешко месо шол 1 кг</option>
								<option value="24">24. Телешко месо за готвене 1 кг</option>
								<option value="25">25. Мляно месо смес 60/40, насипно за 1 кг</option>
								<option value="26">26. Кренвирши, насипни за 1 кг.</option>
								<option value="27">27. Колбаси пресни от 300 гр. до 1 кг.</option>
								<option value="28">28. Колбаси сухи (Шпек, Бургас, Деликатесен) от 250 гр. до 1 кг.</option>
								<option value="29">29. Риба замразена (скумрия, пъстърва, лаврак, ципура) 1 кг</option>
								<option value="31">31. Яйца размер М от 6 бр. до 10 бр. Подово отглеждане</option>
								<option value="32">32. Яйца размер L 6 бр. до 10 бр. Подово отглеждане</option>
								<option value="33">33. Боб, пакетиран 1 кг</option>
								<option value="34">34. Леща, пакетиран 1 кг</option>
								<option value="35">35. Бисерен ориз 1 кг</option>
								<option value="36">36. Макарони от 400 гр. до 500 гр.</option>
								<option value="37">37. Спагети (№ 3, № 5 и № 10) 500 гр.</option>
								<option value="38">38. Бяла захар 1 кг</option>
								<option value="39">39. Готварска сол 1 кг</option>
								<option value="40">40. Брашно тип 500 1 кг</option>
								<option value="41">41. Брашно екстра 1 кг</option>
								<option value="42">42. Олио слънчогледово 1 л</option>
								<option value="43">43. Зехтин 1л</option>
								<option value="44">44. Винен оцет 700 мл.</option>
								<option value="45">45. Ябълков оцет 700 мл.</option>
								<option value="46">46. Консерви боб, от 400 гр. до 800 гр.</option>
								<option value="47">47. Консерви грах, от 400 гр. до 800 гр.</option>
								<option value="48">48. Консервирани домати, от 400 гр. до 800 гр.</option>
								<option value="49">49. Лютеница, от 400 гр. до 800 гр.</option>
								<option value="62">62. Маслини, насипни 1 кг</option>
								<option value="63">63. Каша (млечна, плодова) от 190 гр. до 250 гр.</option>
								<option value="64">64. Детско пюре от 190 гр. до 250 гр.</option>
								<option value="65">65. Адаптирани млека от 400 гр. до 800 гр.</option>
								<option value="66">66. Обикновени бисквити</option>
								<option value="67">67. Кроасани от 50 гр. до 110 гр.</option>
								<option value="68">68. Баница от 100 гр. до 500 гр.</option>
								<option value="69">69. Шоколад, млечен, от 80 гр. до 100 гр.</option>
								<option value="70">70. Кафе мляно от 200 гр. до 250 гр.</option>
								<option value="71">71. Кафе на зърна 1 кг</option>
								<option value="72">72. Чай (билков на пакетчета)</option>
								<option value="73">73. Минерална вода, 6 бр. в опаковка по 1,5 л.</option>
								<option value="74">74. Светла бира 2 л.</option>
								<option value="75">75. Бяло вино бутилирано, произход България 750 мл.</option>
								<option value="76">76. Червено вино бутилирано, произход България 750 мл.</option>
								<option value="77">77. Ракия, произход България 700 мл.</option>
								<option value="78">78. Тютюневи изделия, произход България, кутия, пакет</option>
								<option value="79">79. Течен препарат за миене на съдове от 400 мл.</option>
								<option value="80">80. Четка за зъби – средна твърдост</option>
								<option value="81">81. Паста за зъби, туба от 50 мл. до 125 мл.</option>
								<option value="82">82. Шампоан за нормална коса – от 250 мл. до 500 мл.</option>
								<option value="83">83. Сапун, твърд</option>
								<option value="84">84. Класически мокри кърпи пакет</option>
								<option value="85">85. Тоалетна хартия 8 ролки</option>
							</select>
						</div>
					</div>

					<!-- Search section -->
					<div class="search-section">
						<div class="row">
							<div class="col-md-8">
								<div class="input-group">
									<span class="input-group-text bg-light">
										<i class="bi bi-search"></i>
									</span>
									<input type="text" class="form-control" placeholder="Търсене на продукти..." id="searchInput">
									<button class="btn btn-primary" type="button" id="searchButton">
										Търси
									</button>
								</div>
								<small class="text-muted mt-1">Можете да търсите с части от думите, напр. "кис мл 2%" ще намери "кисело мляко 2%"</small>
							</div>
							<div class="col-md-4 action-buttons">
								<button class="btn btn-success" id="addToCategory">
									<i class="bi bi-plus-circle"></i> Добави към категория
								</button>
								<button class="btn btn-danger" id="removeFromCategory">
									<i class="bi bi-dash-circle"></i> Премахни от категория
								</button>
								<button class="btn btn-outline-secondary" id="clearSelection">
									Изчисти избора
								</button>
							</div>
						</div>
					</div>

					<!-- Items table -->
					<div class="table-container">
						<table class="table table-hover">
							<thead class="table-light">
								<tr>
									<th scope="col" width="50">
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="selectAll">
											<label class="form-check-label" for="selectAll"></label>
										</div>
									</th>
									<th scope="col">Населено място</th>
									<th scope="col">Търговски обект</th>
									<th scope="col">Наименование на продукта</th>
									<th scope="col">Код на продукта</th>
									<th scope="col">Категория</th>
									<th scope="col">Цена на дребно</th>
									<th scope="col">Цена в промоция</th>
								</tr>
							</thead>
							<tbody id="productsTableBody">
								<!-- Table rows will be populated by JavaScript -->
							</tbody>
						</table>
						<div id="searchPrompt" class="search-prompt" style="display: none;">
							<i class="bi bi-search" style="font-size: 3rem;"></i>
							<h4>Въведете критерии за търсене</h4>
							<p>Използвайте полето за търсене по-горе, за да намерите продукти.</p>
							<p><small>Можете да търсите с части от думите, напр. "кис мл" ще намери "кисело мляко"</small></p>
						</div>
						<div id="noResults" class="no-results" style="display: none;">
							<i class="bi bi-search" style="font-size: 3rem;"></i>
							<h4>Няма намерени продукти</h4>
							<p>Променете критериите за търсене и опитайте отново.</p>
						</div>
					</div>

					<!-- Selection summary -->
					<div class="alert alert-info mt-3 mb-0">
						<strong>Избрани продукти: <span id="selectedCount">0</span></strong>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		let currentProducts = [];

		// Check processing status periodically
		function checkProcessingStatus() {
		fetch('/api/processing-status')
			.then(response => response.json())
			.then(data => {
			// Update loading screen
			document.getElementById('loadingProgress').style.width = data.progress + '%';
			document.getElementById('progressPercent').textContent = data.progress;
			document.getElementById('currentMarket').textContent = data.current_market || '-';
			document.getElementById('loadingMessage').textContent = data.message;

			// Handle errors
			if (data.error) {
				document.getElementById('loadingTitle').textContent = 'Грешка при обработка';
				document.getElementById('errorText').textContent = data.error;
				document.getElementById('errorMessage').style.display = 'block';
				return;
			}

			// Check if processing is complete
			if (!data.is_processing) {
				// Hide loading screen and show main content
				document.getElementById('loadingScreen').style.display = 'none';
				document.getElementById('mainContent').style.display = 'flex';
				// Show search prompt initially
				showSearchPrompt();
				initializeApplication();
			} else {
				// Continue checking status
				setTimeout(checkProcessingStatus, 1000);
			}
			})
			.catch(error => {
			console.error('Error checking status:', error);
			document.getElementById('loadingMessage').textContent = 'Грешка при свързване със сървъра. Опитване отново...';
			setTimeout(checkProcessingStatus, 3000);
			});
		}

		// Show search prompt when no search term is entered
		function showSearchPrompt() {
		const tbody = document.getElementById('productsTableBody');
		const noResults = document.getElementById('noResults');
		const searchPrompt = document.getElementById('searchPrompt');
		const exportButton = document.getElementById('exportCsv');
		
		tbody.innerHTML = '';
		noResults.style.display = 'none';
		searchPrompt.style.display = 'block';
		exportButton.disabled = true;
		}

		// Load products from the server
		function loadProducts(searchTerm = '') {
		let url = '/api/search';
		if (searchTerm) {
			url += '?q=' + encodeURIComponent(searchTerm);
		}

		fetch(url)
			.then(response => response.json())
			.then(data => {
			if (data.error) {
				console.error('Error loading products:', data.error);
				return;
			}
			
			currentProducts = data.products || [];
			displayProducts(currentProducts, data.search_term);
			})
			.catch(error => {
			console.error('Error loading products:', error);
			});
		}

		// Display products in the table
		function displayProducts(products, searchTerm) {
		const tbody = document.getElementById('productsTableBody');
		const noResults = document.getElementById('noResults');
		const searchPrompt = document.getElementById('searchPrompt');
		const exportButton = document.getElementById('exportCsv');

		// Hide both prompts initially
		noResults.style.display = 'none';
		searchPrompt.style.display = 'none';

		if (products.length === 0) {
			tbody.innerHTML = '';
			if (!searchTerm || searchTerm.trim() === '') {
			// Show search prompt when no search term
			searchPrompt.style.display = 'block';
			} else {
			// Show no results when search term returns nothing
			noResults.style.display = 'block';
			}
			exportButton.disabled = true;
			return;
		}

		exportButton.disabled = false;

		tbody.innerHTML = products.map(product => {
			const isCategorized = product.item_kzp_category_code && product.item_kzp_category_code !== '';
			const rowClass = isCategorized ? 'categorized-row' : '';
			const categoryDisplay = isCategorized ?
			`<span class="category-badge">${product.item_kzp_category_name}</span>` : '';

			return `
			<tr class="${rowClass}" data-product-id="${product.id}">
			<td>
				<div class="form-check">
				<input class="form-check-input item-checkbox" type="checkbox" name="item" value="${product.id}">
				</div>
			</td>
			<td>${product.settlement || ''}</td>
			<td>${product.market_name || ''}</td>
			<td>${product.item_name || ''}</td>
			<td>${product.item_code || ''}</td>
			<td>${categoryDisplay}</td>
			<td>${product.item_retail_price || ''}</td>
			<td>${product.item_promotional_price || ''}</td>
			</tr>
			`;
		}).join('');

		updateSelectedCount();
		}

		// Update selected count function
		function updateSelectedCount() {
		const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
		document.getElementById('selectedCount').textContent = selectedCheckboxes.length;
		
		// Update select all checkbox state
		const totalCheckboxes = document.querySelectorAll('.item-checkbox');
		document.getElementById('selectAll').checked = selectedCheckboxes.length > 0 && selectedCheckboxes.length === totalCheckboxes.length;
		}

		// Initialize the main application after loading is complete
		function initializeApplication() {
		// Use event delegation for checkbox changes
		document.getElementById('productsTableBody').addEventListener('change', function(e) {
			if (e.target && e.target.classList.contains('item-checkbox')) {
			updateSelectedCount();
			}
		});

		// Select all functionality
		document.getElementById('selectAll').addEventListener('change', function() {
			const checkboxes = document.querySelectorAll('.item-checkbox');
			checkboxes.forEach(checkbox => {
			checkbox.checked = this.checked;
			});
			updateSelectedCount();
		});

		// Clear selection button
		document.getElementById('clearSelection').addEventListener('click', function() {
			document.getElementById('selectAll').checked = false;
			const checkboxes = document.querySelectorAll('.item-checkbox');
			checkboxes.forEach(checkbox => {
			checkbox.checked = false;
			});
			updateSelectedCount();
		});

		// Add to category button
		document.getElementById('addToCategory').addEventListener('click', function() {
			const selectedCategory = document.getElementById('categorySelect').value;
			if (!selectedCategory) {
			alert('Моля, изберете категория преди да добавите продукти.');
			return;
			}

			const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
			const selectedProductIds = Array.from(selectedCheckboxes).map(cb => cb.value);

			if (selectedProductIds.length === 0) {
			alert('Моля, изберете поне един продукт преди да го добавите към категория.');
			return;
			}

			// Send request to update categories
			fetch('/api/update-category', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				product_ids: selectedProductIds,
				category_code: selectedCategory
			})
			})
			.then(response => response.json())
			.then(data => {
			if (data.success) {
				// Update the UI to show the new categories
				selectedProductIds.forEach(productId => {
				const row = document.querySelector(`tr[data-product-id="${productId}"]`);
				if (row) {
					row.classList.add('categorized-row');
					const categoryCell = row.cells[5];
					categoryCell.innerHTML = `<span class="category-badge">${data.category_name}</span>`;
				}
				});

				// Clear selection
				document.getElementById('selectAll').checked = false;
				selectedCheckboxes.forEach(checkbox => {
				checkbox.checked = false;
				});
				updateSelectedCount();
			} else {
				alert('Грешка при добавяне на категория: ' + data.error);
			}
			})
			.catch(error => {
			console.error('Error updating category:', error);
			alert('Грешка при добавяне на категория.');
			});
		});

		// Remove from category button
		document.getElementById('removeFromCategory').addEventListener('click', function() {
			const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
			const selectedProductIds = Array.from(selectedCheckboxes).map(cb => cb.value);
			
			if (selectedProductIds.length === 0) {
			alert('Моля, изберете поне един продукт преди да го премахнете от категория.');
			return;
			}

			// Send request to remove categories
			fetch('/api/remove-category', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				product_ids: selectedProductIds
			})
			})
			.then(response => response.json())
			.then(data => {
			if (data.success) {
				// Update the UI to remove the categories
				selectedProductIds.forEach(productId => {
				const row = document.querySelector(`tr[data-product-id="${productId}"]`);
				if (row) {
					row.classList.remove('categorized-row');
					const categoryCell = row.cells[5];
					categoryCell.innerHTML = '';
				}
				});

				// Clear selection
				document.getElementById('selectAll').checked = false;
				selectedCheckboxes.forEach(checkbox => {
				checkbox.checked = false;
				});
				updateSelectedCount();
			} else {
				alert('Грешка при премахване на категория: ' + data.error);
			}
			})
			.catch(error => {
			console.error('Error removing category:', error);
			alert('Грешка при премахване на категория.');
			});
		});

		// Search functionality
		document.getElementById('searchButton').addEventListener('click', function() {
			const searchTerm = document.getElementById('searchInput').value.trim();
			if (searchTerm) {
			loadProducts(searchTerm);
			} else {
			showSearchPrompt();
			}
		});

		// Search on Enter key
		document.getElementById('searchInput').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
			document.getElementById('searchButton').click();
			}
		});

		// Export CSV functionality
		document.getElementById('exportCsv').addEventListener('click', function() {
			window.open('/api/export-csv', '_blank');
		});
		}

		// Start checking processing status when page loads
		document.addEventListener('DOMContentLoaded', function() {
		checkProcessingStatus();
		});
	</script>

</body>
</html>
